<!DOCTYPE html>
<html lang="kk">
<head>
  <meta charset="UTF-8">
  <title>Sulifa 1v1 Bet Rooms</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
</head>

<body class="bg-gray-900 text-white min-h-screen flex items-center justify-center">

<div class="w-full max-w-md bg-gray-800 rounded-xl p-6 shadow-xl">

  <h1 class="text-2xl font-bold text-center mb-4">๐ชจ๐โ๏ธ ะกัะปะธัะฐ 1v1</h1>

  <!-- PLAYER INFO -->
  <div class="text-center mb-4">
    <div>ID: <span id="tgId" class="font-mono text-xs break-all"></span></div>
    <div class="mt-2 text-lg">ะะฐะปะฐะฝั: <span id="balance">0</span> ๐ฐ</div>
  </div>

  <!-- SCORE -->
  <div id="scorePanel" class="text-center mb-4 hidden">
    <div>ะกะตะฝ: <span id="myScore">0</span> | าะฐัััะปะฐั: <span id="opponentScore">0</span></div>
  </div>

  <!-- TIMER -->
  <div id="timerPanel" class="text-center text-yellow-400 mb-4 hidden">
    โณ ะฃะฐาัั าะฐะปะดั: <span id="timer">15</span> ัะตะบ
  </div>

  <!-- BET ROOMS -->
  <div id="betPanel" class="mb-4">
    <div class="text-center mb-2 font-semibold">ะกัะฐะฒะบะฐ ะฑำฉะปะผะตััะฝ ัะฐาฃะดะฐ</div>
    <div class="grid grid-cols-4 gap-2">
      <button onclick="joinRoom(500)" class="bet-btn bg-gray-700 p-2 rounded">500</button>
      <button onclick="joinRoom(1000)" class="bet-btn bg-gray-700 p-2 rounded">1000</button>
      <button onclick="joinRoom(1500)" class="bet-btn bg-gray-700 p-2 rounded">1500</button>
      <button onclick="joinRoom(2000)" class="bet-btn bg-gray-700 p-2 rounded">2000</button>
    </div>
  </div>

  <!-- STATUS -->
  <div id="status" class="text-center text-yellow-400 mb-4">ะกะตัะฒะตัะณะต าะพััะปั...</div>

  <!-- GAME BUTTONS -->
  <div id="gamePanel" class="hidden grid grid-cols-3 gap-3 mb-4">
    <button onclick="sendChoice('rock')" class="bg-blue-600 p-3 rounded">๐ชจ</button>
    <button onclick="sendChoice('paper')" class="bg-green-600 p-3 rounded">๐</button>
    <button onclick="sendChoice('scissors')" class="bg-red-600 p-3 rounded">โ๏ธ</button>
  </div>

  <!-- RESULT -->
  <div id="result" class="hidden text-center text-lg font-semibold mb-4"></div>

  <!-- RESTART -->
  <button id="restart" onclick="resetGame()" class="hidden mt-4 w-full bg-purple-600 p-2 rounded">
    ๐ าะฐะนัะฐ ะพะนะฝะฐั
  </button>

</div>

<script>
const SERVER = "https://sulifaonlinerender.onrender.com";
const tg = window.Telegram.WebApp;
tg.expand();
const tgId = tg.initDataUnsafe?.user?.id?.toString();
if (!tgId) alert("Telegram ID ัะฐะฑัะปะผะฐะดั");

let socket, myBalance = 0, selectedBet = null;
let timerInterval = null, timerValue = 15;

document.getElementById("tgId").innerText = tgId;

fetch(`${SERVER}/player`, {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify({ tgId })
}).then(r => r.json())
  .then(p => {
    myBalance = p.balance;
    updateBalance();
    connectSocket();
  });

function connectSocket() {
  socket = io(SERVER);

  socket.on("waiting", () => setStatus("โณ าะฐัััะปะฐั ะบาฏััะปัะดะต..."));
  
  socket.on("game_start", data => {
    document.getElementById("betPanel").classList.add("hidden");
    setStatus("๐ฎ ะขะฐาฃะดะฐ!");
    showGame();
    document.getElementById("scorePanel").classList.remove("hidden");
    updateScore(data.score[tgId] || 0, getOpponentScore(data.score));
    startTimer();
  });

  socket.on("round_result", data => {
    hideGame();
    stopTimer();
    const myChoice = data.p1 === tgId ? data.p1 : data.p2;
    const oppChoice = data.p1 !== tgId ? data.p1 : data.p2;
    updateScore(data.score[tgId], getOpponentScore(data.score));
    setStatus("ะะฐัะฝะด ะฐัาัะฐะปะดั");
    showResult(`ะกะตะฝ: ${icon(data.p1)} | าะฐัััะปะฐั: ${icon(data.p2)}`);
    startTimer();
    showGame();
  });

  socket.on("game_over", data => {
    hideGame();
    stopTimer();
    const won = data.winner === tgId;
    setStatus(won ? "๐ ะกะตะฝ ะถะตาฃะดัาฃ!" : "โ ะกะตะฝ ะถะตาฃัะปะดัาฃ");
    showResult(`ะคะธะฝะฐะปะดัา score: ะกะตะฝ ${data.score[tgId]} | าะฐัััะปะฐั ${getOpponentScore(data.score)}`);
    document.getElementById("restart").classList.remove("hidden");
  });

  socket.on("error_msg", msg => { alert(msg); resetGame(); });
}

function joinRoom(bet) {
  if (myBalance < bet) return alert("ะะฐะปะฐะฝั ะถะตัะบัะปัะบััะท");
  selectedBet = bet;
  document.querySelectorAll(".bet-btn").forEach(b => b.classList.remove("bg-green-600"));
  event.target.classList.add("bg-green-600");
  setStatus("ะะนัะฝาะฐ าะพััะปั...");
  socket.emit("join_game", { tgId, bet });
}

function sendChoice(choice) {
  hideGame();
  setStatus("โณ าะฐัััะปะฐั ัะฐาฃะดะฐัะดะฐ...");
  socket.emit("choice", choice);
}

function resetGame() {
  selectedBet = null;
  document.getElementById("betPanel").classList.remove("hidden");
  document.getElementById("result").classList.add("hidden");
  document.getElementById("restart").classList.add("hidden");
  document.getElementById("scorePanel").classList.add("hidden");
  document.getElementById("timerPanel").classList.add("hidden");
  setStatus("ะกัะฐะฒะบะฐ ะฑำฉะปะผะตััะฝ ัะฐาฃะดะฐ");
  stopTimer();
}

function updateBalance() { document.getElementById("balance").innerText = myBalance; }
function setStatus(t) { document.getElementById("status").innerText = t; }
function showGame() { document.getElementById("gamePanel").classList.remove("hidden"); document.getElementById("timerPanel").classList.remove("hidden"); startTimer(); }
function hideGame() { document.getElementById("gamePanel").classList.add("hidden"); }
function showResult(text) { const r = document.getElementById("result"); r.innerHTML = text; r.classList.remove("hidden"); }

function updateScore(my, opp) {
  document.getElementById("myScore").innerText = my;
  document.getElementById("opponentScore").innerText = opp;
}

function getOpponentScore(scoreObj) {
  for (const key in scoreObj) { if (key !== tgId) return scoreObj[key]; }
  return 0;
}

function icon(v) { return v === "rock" ? "๐ชจ" : v === "paper" ? "๐" : "โ๏ธ"; }

// ================= TIMER =================
function startTimer() {
  stopTimer();
  timerValue = 15;
  document.getElementById("timer").innerText = timerValue;
  document.getElementById("timerPanel").classList.remove("hidden");
  timerInterval = setInterval(() => {
    timerValue--;
    document.getElementById("timer").innerText = timerValue;
    if (timerValue <= 0) {
      clearInterval(timerInterval);
      setStatus("โฑ ะฃะฐาัั ะฐัาัะฐะปะดั!");
    }
  }, 1000);
}

function stopTimer() {
  if (timerInterval) clearInterval(timerInterval);
}
</script>

</body>
</html>
