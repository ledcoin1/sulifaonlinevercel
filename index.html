<!DOCTYPE html>
<html lang="kk">
<head>
  <meta charset="UTF-8">
  <title>Sulifa 1v1</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
</head>
<body class="bg-gradient-to-b from-gray-900 via-gray-800 to-gray-900 text-white min-h-screen flex flex-col">

  <!-- HEADER -->
  <header class="flex justify-between items-center p-4 bg-gradient-to-r from-purple-700 via-pink-600 to-red-500 shadow-lg">
    <div class="text-sm font-mono break-all">ID: <span id="tgId"></span></div>
    <div class="text-lg font-semibold">–ë–∞–ª–∞–Ω—Å: <span id="balance">0</span> üí∞</div>
  </header>

  <!-- MAIN PANEL -->
  <main class="flex-1 flex flex-col items-center justify-center px-4">

    <h1 class="text-3xl md:text-4xl font-bold mb-6 text-center bg-clip-text text-transparent bg-gradient-to-r from-yellow-400 to-pink-500">
      ü™®üìÑ‚úÇÔ∏è –°—É–ª–∏—Ñ–∞ 1v1
    </h1>

    <!-- STATUS -->
    <div id="status" class="text-center text-yellow-400 mb-4 text-lg font-semibold">
      –°—Ç–∞–≤–∫–∞ —Ç–∞“£–¥–∞
    </div>

    <!-- BET ROOMS -->
    <div id="betPanel" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6 w-full max-w-xl">
      <button onclick="joinRoom(500)" class="bet-btn">500</button>
      <button onclick="joinRoom(1000)" class="bet-btn">1000</button>
      <button onclick="joinRoom(1500)" class="bet-btn">1500</button>
      <button onclick="joinRoom(2000)" class="bet-btn">2000</button>
    </div>

    <!-- TIMER -->
    <div id="timerBox" class="hidden w-full max-w-xs mb-4">
      <div class="flex items-center justify-between text-sm mb-1">‚è±Ô∏è –¢–∞–π–º–µ—Ä: <span id="timer">15</span> —Å–µ–∫</div>
      <div class="w-full h-2 bg-gray-700 rounded">
        <div id="timerBar" class="h-2 bg-green-400 rounded w-full transition-all"></div>
      </div>
    </div>

    <!-- GAME PANEL -->
    <div id="gamePanel" class="hidden grid grid-cols-3 gap-4 mb-6 w-full max-w-md">
      <button onclick="sendChoice('rock')" class="choice">ü™®</button>
      <button onclick="sendChoice('paper')" class="choice">üìÑ</button>
      <button onclick="sendChoice('scissors')" class="choice">‚úÇÔ∏è</button>
    </div>

    <!-- RESULT -->
    <div id="result" class="hidden text-center text-xl font-bold py-3 px-4 rounded mb-4"></div>

    <!-- RESTART -->
    <button id="restart" onclick="resetGame()" class="hidden w-full max-w-md p-3 rounded bg-purple-600 hover:bg-purple-700 transition-colors font-semibold">
      üîÅ “ö–∞–π—Ç–∞ –æ–π–Ω–∞—É
    </button>
  </main>

<script>
const SERVER = "https://sulifaonlinerender.onrender.com";
const tg = window.Telegram.WebApp;
tg.expand();

const tgId = tg.initDataUnsafe?.user?.id?.toString() || "test_" + Math.random();
document.getElementById("tgId").innerText = tgId;

let socket;
let myBalance = 0;
let currentRoom = null;
let timerInterval;

// LOCK FLAGS
let isJoining = false;
let inGame = false;

// ---------- LOAD PLAYER ----------
fetch(`${SERVER}/player`, {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify({ tgId })
})
.then(r => r.json())
.then(p => {
  myBalance = p.balance;
  updateBalance();
  connectSocket();
});

// ---------- SOCKET ----------
function connectSocket() {
  socket = io(SERVER);

  socket.on("waiting", () => setStatus("‚è≥ “ö–∞—Ä—Å—ã–ª–∞—Å –∫“Ø—Ç—ñ–ª—É–¥–µ..."));

  socket.on("game_start", ({ roomId }) => {
    inGame = true; isJoining = false;
    currentRoom = roomId;
    document.getElementById("betPanel").classList.add("hidden");
    disableBetButtons(true);
    setStatus("üéÆ –¢–∞“£–¥–∞!");
    showGame();
    startTimer();
  });

  socket.on("game_result", data => {
    stopTimer();
    hideGame();
    inGame = false; isJoining = false;
    disableBetButtons(false);

    let text = data.winner === "draw"
      ? "ü§ù –¢–µ“£!"
      : data.winner === tgId ? "üèÜ –°–µ–Ω –∂–µ“£–¥—ñ“£!" : "‚ùå –°–µ–Ω –∂–µ“£—ñ–ª–¥—ñ“£";

    const resultBox = document.getElementById("result");
    resultBox.innerText = text;
    resultBox.classList.remove("hidden");
    resultBox.classList.remove("bg-green-500","bg-red-500","bg-yellow-400");
    if(data.winner === tgId) resultBox.classList.add("bg-green-500");
    else if(data.winner === "draw") resultBox.classList.add("bg-yellow-400");
    else resultBox.classList.add("bg-red-500");

    document.getElementById("restart").classList.remove("hidden");
    reloadBalance();
  });

  socket.on("error_msg", msg => { alert(msg); resetGame(); });
}

// ---------- JOIN ----------
function joinRoom(bet) {
  if (isJoining || inGame) return;
  if (myBalance < bet) { alert("–ë–∞–ª–∞–Ω—Å –∂–µ—Ç–∫—ñ–ª—ñ–∫—Å—ñ–∑"); return; }

  isJoining = true;
  disableBetButtons(true);
  setStatus("‚è≥ “ö–∞—Ä—Å—ã–ª–∞—Å –∫“Ø—Ç—ñ–ª—É–¥–µ...");
  socket.emit("join_room", { tgId, bet });
}

// ---------- GAME ----------
function sendChoice(choice) {
  if (!inGame) return;
  hideGame();
  setStatus("‚è≥ “ö–∞—Ä—Å—ã–ª–∞—Å —Ç–∞“£–¥–∞—É–¥–∞...");
  socket.emit("choice", { roomId: currentRoom, choice });
}

// ---------- TIMER ----------
function startTimer() {
  let t = 15;
  document.getElementById("timer").innerText = t;
  document.getElementById("timerBox").classList.remove("hidden");

  const bar = document.getElementById("timerBar");
  bar.style.width = "100%";

  timerInterval = setInterval(() => {
    t--;
    document.getElementById("timer").innerText = t;
    bar.style.width = `${(t/15)*100}%`;
    if(t<=0) stopTimer();
  },1000);
}

function stopTimer() {
  clearInterval(timerInterval);
  document.getElementById("timerBox").classList.add("hidden");
}

// ---------- UI ----------
function resetGame() {
  currentRoom = null; inGame = false; isJoining = false;
  disableBetButtons(false); hideGame();
  document.getElementById("result").classList.add("hidden");
  document.getElementById("restart").classList.add("hidden");
  document.getElementById("betPanel").classList.remove("hidden");
  setStatus("–°—Ç–∞–≤–∫–∞ —Ç–∞“£–¥–∞");
}

function disableBetButtons(state) {
  document.querySelectorAll(".bet-btn").forEach(btn=>{
    btn.disabled = state;
    btn.classList.toggle("opacity-50", state);
    btn.classList.toggle("cursor-not-allowed", state);
  });
}

function updateBalance(){ document.getElementById("balance").innerText = myBalance; }
function reloadBalance(){
  fetch(`${SERVER}/player`,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({tgId})
  }).then(r=>r.json()).then(p=>{ myBalance=p.balance; updateBalance(); });
}

function setStatus(text){ document.getElementById("status").innerText=text; }
function showGame(){ document.getElementById("gamePanel").classList.remove("hidden"); }
function hideGame(){ document.getElementById("gamePanel").classList.add("hidden"); }
</script>

<style>
.bet-btn{
  background:#4f46e5;
  padding:12px;
  font-size:18px;
  border-radius:12px;
  font-semibold;
  transition: all 0.2s;
}
.bet-btn:hover{
  transform: translateY(-2px);
  background:#6366f1;
}
.choice{
  background:#1f2937;
  font-size:36px;
  padding:16px;
  border-radius:16px;
  transition: all 0.2s;
}
.choice:hover{
  transform: translateY(-2px);
  background:#374151;
}
</style>

</body>
</html>
