<!DOCTYPE html>
<html lang="kk">
<head>
  <meta charset="UTF-8" />
  <title>Sulifa 1v1</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Telegram Mini App -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Socket.io -->
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
</head>

<body class="bg-gray-900 text-white flex items-center justify-center min-h-screen">

<div class="w-full max-w-md bg-gray-800 rounded-xl p-6 shadow-xl">

  <!-- HEADER -->
  <h1 class="text-2xl font-bold text-center mb-4">ü™®üìÑ‚úÇÔ∏è –°—É–ª–∏—Ñ–∞ 1v1</h1>

  <!-- PLAYER INFO -->
  <div class="text-center mb-4">
    <div>ID: <span id="tgId" class="font-mono text-sm"></span></div>
    <div class="mt-1">–ë–∞–ª–∞–Ω—Å: <span id="balance" class="font-bold">0</span></div>
  </div>

  <!-- STATUS -->
  <div id="status" class="text-center text-yellow-400 mb-4">
    –°–µ—Ä–≤–µ—Ä–≥–µ “õ–æ—Å—ã–ª—É–¥–∞...
  </div>

  <!-- GAME BUTTONS -->
  <div id="buttons" class="hidden grid grid-cols-3 gap-3 mb-4">
    <button onclick="sendChoice('rock')" class="bg-blue-600 p-3 rounded">ü™®</button>
    <button onclick="sendChoice('paper')" class="bg-green-600 p-3 rounded">üìÑ</button>
    <button onclick="sendChoice('scissors')" class="bg-red-600 p-3 rounded">‚úÇÔ∏è</button>
  </div>

  <!-- RESULT -->
  <div id="result" class="hidden text-center text-lg font-semibold"></div>

  <!-- RESTART -->
  <button id="restart"
    onclick="joinGame()"
    class="hidden mt-4 w-full bg-purple-600 p-2 rounded">
    üîÅ “ö–∞–π—Ç–∞ –æ–π–Ω–∞—É
  </button>

</div>

<script>
/* ================= CONFIG ================= */
const SERVER = "https://sulifaonlinerender.onrender.com";

/* ================= TELEGRAM ================= */
const tg = window.Telegram.WebApp;
tg.expand();

// ‚ö†Ô∏è –ù–ê–°–¢–û–Ø–©–ò–ô Telegram ID
const tgId = tg.initDataUnsafe?.user?.id?.toString();

if (!tgId) {
  alert("Telegram ID —Ç–∞–±—ã–ª–º–∞–¥—ã");
}

/* ================= STATE ================= */
let socket;
let myBalance = 0;

/* ================= UI ================= */
document.getElementById("tgId").innerText = tgId;

/* ================= REGISTER PLAYER ================= */
fetch(`${SERVER}/player`, {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify({ tgId })
})
.then(r => r.json())
.then(p => {
  myBalance = p.balance;
  document.getElementById("balance").innerText = myBalance;
  connectSocket();
});

/* ================= SOCKET ================= */
function connectSocket() {
  socket = io(SERVER);

  socket.on("connect", () => {
    joinGame();
  });

  socket.on("waiting", () => {
    setStatus("‚è≥ –û–π—ã–Ω—à—ã –∫“Ø—Ç—ñ–ª—É–¥–µ...");
    hideButtons();
  });

  socket.on("game_start", () => {
    setStatus("üéÆ –û–π—ã–Ω –±–∞—Å—Ç–∞–ª–¥—ã! –¢–∞“£–¥–∞");
    showButtons();
  });

  socket.on("game_result", data => {
    hideButtons();

    let text = `–°–µ–Ω: ${icon(data.p1)} | “ö–∞—Ä—Å—ã–ª–∞—Å: ${icon(data.p2)}<br>`;

    if (data.winner === "draw") {
      text += "ü§ù –¢–µ“£!";
    } else if (data.winner === tgId) {
      text += "üèÜ –°–µ–Ω –∂–µ“£–¥—ñ“£!";
      myBalance++;
    } else {
      text += "‚ùå –°–µ–Ω –∂–µ“£—ñ–ª–¥—ñ“£";
      myBalance--;
    }

    document.getElementById("balance").innerText = myBalance;
    document.getElementById("result").innerHTML = text;
    document.getElementById("result").classList.remove("hidden");
    document.getElementById("restart").classList.remove("hidden");
    setStatus("–û–π—ã–Ω –∞—è“õ—Ç–∞–ª–¥—ã");
  });
}

/* ================= GAME ================= */
function joinGame() {
  document.getElementById("result").classList.add("hidden");
  document.getElementById("restart").classList.add("hidden");
  setStatus("–°–µ—Ä–≤–µ—Ä–≥–µ “õ–æ—Å—ã–ª—É...");
  socket.emit("join_game", tgId);
}

function sendChoice(choice) {
  hideButtons();
  setStatus("‚è≥ “ö–∞—Ä—Å—ã–ª–∞—Å—Ç—ã –∫“Ø—Ç—É...");
  socket.emit("choice", choice);
}

/* ================= HELPERS ================= */
function setStatus(text) {
  document.getElementById("status").innerText = text;
}

function showButtons() {
  document.getElementById("buttons").classList.remove("hidden");
}

function hideButtons() {
  document.getElementById("buttons").classList.add("hidden");
}

function icon(v) {
  return v === "rock" ? "ü™®" : v === "paper" ? "üìÑ" : "‚úÇÔ∏è";
}
</script>

</body>
</html>
