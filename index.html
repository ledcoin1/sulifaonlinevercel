<!DOCTYPE html>
<html lang="kk">
<head>
  <meta charset="UTF-8">
  <title>Sulifa 1v1</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
</head>

<body class="bg-gradient-to-b from-gray-900 via-gray-800 to-gray-900 text-white min-h-screen flex flex-col">

<!-- HEADER -->
<header class="flex justify-between items-center p-4 bg-gradient-to-r from-purple-700 via-pink-600 to-red-500 shadow-lg">
  <div class="text-xs font-mono">ID: <span id="tgId"></span></div>

  <div class="flex items-center gap-3">
    <div class="text-lg font-semibold">üí∞ <span id="balance">0</span></div>
    <button onclick="openNov()"
      class="px-3 py-1 rounded-lg bg-black/30 hover:bg-black/50 transition text-sm font-bold">
      NoV
    </button>
  </div>
</header>

<!-- MAIN -->
<main class="flex-1 flex flex-col items-center justify-center px-4">

  <h1 class="text-3xl font-bold mb-4 bg-clip-text text-transparent bg-gradient-to-r from-yellow-400 to-pink-500">
    ü™®üìÑ‚úÇÔ∏è –°—É–ª–∏—Ñ–∞ 1v1
  </h1>

  <div id="status" class="mb-4 text-yellow-400 font-semibold">–°—Ç–∞–≤–∫–∞ —Ç–∞“£–¥–∞</div>

  <!-- BET -->
  <div id="betPanel" class="grid grid-cols-2 md:grid-cols-4 gap-4 w-full max-w-xl mb-6">
    <button onclick="joinRoom(500)" class="bet-btn">500</button>
    <button onclick="joinRoom(1000)" class="bet-btn">1000</button>
    <button onclick="joinRoom(1500)" class="bet-btn">1500</button>
    <button onclick="joinRoom(2000)" class="bet-btn">2000</button>
  </div>

  <!-- TIMER -->
  <div id="timerBox" class="hidden w-full max-w-xs mb-4">
    <div class="flex justify-between text-sm mb-1">
      ‚è±Ô∏è <span id="timer">15</span> —Å–µ–∫
    </div>
    <div class="h-2 bg-gray-700 rounded">
      <div id="timerBar" class="h-2 bg-green-400 rounded w-full transition-all"></div>
    </div>
  </div>

  <!-- GAME -->
  <div id="gamePanel" class="hidden grid grid-cols-3 gap-4 mb-6">
    <button onclick="sendChoice('rock')" class="choice">ü™®</button>
    <button onclick="sendChoice('paper')" class="choice">üìÑ</button>
    <button onclick="sendChoice('scissors')" class="choice">‚úÇÔ∏è</button>
  </div>

  <div id="result" class="hidden text-xl font-bold mb-4 px-4 py-2 rounded"></div>

  <button id="restart" onclick="resetGame()" class="hidden px-6 py-2 bg-purple-600 rounded-lg font-semibold">
    üîÅ “ö–∞–π—Ç–∞ –æ–π–Ω–∞—É
  </button>
</main>

<!-- ================= NoV MODAL ================= -->
<div id="novModal" class="hidden fixed inset-0 bg-black/70 flex items-end justify-center z-50">
  <div class="bg-gray-900 w-full max-w-md rounded-t-3xl p-5 animate-slideUp">
    <h2 class="text-xl font-bold mb-4 text-center">üí∏ –ë–∞–ª–∞–Ω—Å —à—ã“ì–∞—Ä—É</h2>

    <input id="withdrawAmount" type="number" placeholder="–°–æ–º–∞ (–º–∏–Ω 20000)"
      class="w-full mb-3 p-3 rounded bg-gray-800 outline-none">

    <textarea id="withdrawComment" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–º—ñ–Ω–¥–µ—Ç—Ç—ñ)"
      class="w-full mb-4 p-3 rounded bg-gray-800 outline-none"></textarea>

    <button onclick="sendWithdraw()"
      class="w-full bg-green-500 hover:bg-green-600 py-3 rounded-lg font-bold">
      –®—ã“ì–∞—Ä—É
    </button>

    <button onclick="closeNov()" class="w-full mt-3 text-gray-400">
      –ñ–∞–±—É
    </button>
  </div>
</div>

<script>
const SERVER = "https://sulifaonlinerender.onrender.com";
const tg = window.Telegram.WebApp;
tg.expand();

const tgId = tg.initDataUnsafe?.user?.id?.toString() || "test_" + Math.random();
document.getElementById("tgId").innerText = tgId;

let socket, myBalance = 0, currentRoom = null, timerInterval;
let isJoining = false, inGame = false;

// LOAD PLAYER
fetch(`${SERVER}/player`, {
  method:"POST",
  headers:{ "Content-Type":"application/json" },
  body:JSON.stringify({ tgId })
}).then(r=>r.json()).then(p=>{
  myBalance = p.balance;
  updateBalance();
  connectSocket();
});

// SOCKET
function connectSocket(){
  socket = io(SERVER);

  socket.on("waiting",()=>setStatus("‚è≥ “ö–∞—Ä—Å—ã–ª–∞—Å –∫“Ø—Ç—ñ–ª—É–¥–µ..."));

  socket.on("game_start",({roomId})=>{
    inGame=true; isJoining=false;
    currentRoom=roomId;
    betPanel.classList.add("hidden");
    setStatus("üéÆ –¢–∞“£–¥–∞!");
    gamePanel.classList.remove("hidden");
    startTimer();
  });

  socket.on("game_result",d=>{
    stopTimer();
    inGame=false; isJoining=false;
    gamePanel.classList.add("hidden");
    result.classList.remove("hidden");

    result.innerText = d.winner==="draw"
      ? "ü§ù –¢–µ“£!"
      : d.winner===tgId ? "üèÜ –ñ–µ“£—ñ—Å!" : "‚ùå –ñ–µ“£—ñ–ª–¥—ñ“£";

    reloadBalance();
    restart.classList.remove("hidden");
  });
}

// JOIN
function joinRoom(bet){
  if(isJoining||inGame) return;
  if(myBalance<bet) return alert("–ë–∞–ª–∞–Ω—Å –∂–µ—Ç–∫—ñ–ª—ñ–∫—Å—ñ–∑");
  isJoining=true;
  socket.emit("join_room",{ tgId, bet });
}

// GAME
function sendChoice(choice){
  socket.emit("choice",{ roomId:currentRoom, choice });
  gamePanel.classList.add("hidden");
}

// TIMER
function startTimer(){
  let t=15;
  timerBox.classList.remove("hidden");
  timer.innerText=t;
  timerBar.style.width="100%";
  timerInterval=setInterval(()=>{
    t--;
    timer.innerText=t;
    timerBar.style.width=(t/15*100)+"%";
    if(t<=0) stopTimer();
  },1000);
}
function stopTimer(){
  clearInterval(timerInterval);
  timerBox.classList.add("hidden");
}

// UI HELPERS
function resetGame(){
  currentRoom=null;
  betPanel.classList.remove("hidden");
  restart.classList.add("hidden");
  result.classList.add("hidden");
  setStatus("–°—Ç–∞–≤–∫–∞ —Ç–∞“£–¥–∞");
}
function setStatus(t){ status.innerText=t; }
function updateBalance(){ balance.innerText=myBalance; }
function reloadBalance(){
  fetch(`${SERVER}/player`,{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({ tgId })
  }).then(r=>r.json()).then(p=>{
    myBalance=p.balance; updateBalance();
  });
}

// ================= NoV =================
function openNov(){ novModal.classList.remove("hidden"); }
function closeNov(){ novModal.classList.add("hidden"); }

function sendWithdraw(){
  const amount = +withdrawAmount.value;
  const comment = withdrawComment.value.trim();

  if(amount < 20000) return alert("–ú–∏–Ω–∏–º—É–º 20000");
  if(!comment) return alert("–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –º—ñ–Ω–¥–µ—Ç—Ç—ñ");
  if(amount > myBalance) return alert("–ë–∞–ª–∞–Ω—Å –∂–µ—Ç–ø–µ–π–¥—ñ");

  myBalance -= amount;
  updateBalance();
  closeNov();

  fetch(`${SERVER}/withdraw`,{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({ tgId, amount, comment })
  });
}
</script>

<style>
.bet-btn{
  background:#4f46e5;
  padding:14px;
  border-radius:14px;
  font-size:18px;
}
.choice{
  background:#1f2937;
  font-size:36px;
  padding:20px;
  border-radius:18px;
}
@keyframes slideUp{
  from{transform:translateY(100%)}
  to{transform:translateY(0)}
}
.animate-slideUp{ animation:slideUp .3s ease-out }
</style>

</body>
</html>
