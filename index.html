<!DOCTYPE html>
<html lang="kk">
<head>
  <meta charset="UTF-8">
  <title>Sulifa 1v1 Bet</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Telegram Mini App -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Socket.io -->
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
</head>

<body class="bg-gray-900 text-white min-h-screen flex items-center justify-center">

<div class="w-full max-w-md bg-gray-800 rounded-xl p-6 shadow-xl">

  <!-- HEADER -->
  <h1 class="text-2xl font-bold text-center mb-4">ğŸª¨ğŸ“„âœ‚ï¸ Ğ¡ÑƒĞ»Ğ¸Ñ„Ğ° 1v1</h1>

  <!-- PLAYER INFO -->
  <div class="text-center mb-4">
    <div class="text-sm">Telegram ID</div>
    <div id="tgId" class="font-mono text-xs break-all"></div>
    <div class="mt-2 text-lg">Ğ‘Ğ°Ğ»Ğ°Ğ½Ñ: <span id="balance">0</span> ğŸ’°</div>
  </div>

  <!-- BET SELECTION -->
  <div id="betPanel" class="mb-4">
    <div class="text-center mb-2 font-semibold">Ğ¡Ñ‚Ğ°Ğ²ĞºĞ° Ñ‚Ğ°Ò£Ğ´Ğ°</div>
    <div class="grid grid-cols-3 gap-3">
      <button onclick="selectBet(10)" class="bet-btn bg-gray-700 p-3 rounded">10</button>
      <button onclick="selectBet(50)" class="bet-btn bg-gray-700 p-3 rounded">50</button>
      <button onclick="selectBet(100)" class="bet-btn bg-gray-700 p-3 rounded">100</button>
    </div>
  </div>

  <!-- STATUS -->
  <div id="status" class="text-center text-yellow-400 mb-4">
    Ğ¡ĞµÑ€Ğ²ĞµÑ€Ğ³Ğµ Ò›Ğ¾ÑÑ‹Ğ»Ñƒ...
  </div>

  <!-- GAME BUTTONS -->
  <div id="gamePanel" class="hidden grid grid-cols-3 gap-3 mb-4">
    <button onclick="sendChoice('rock')" class="bg-blue-600 p-3 rounded">ğŸª¨</button>
    <button onclick="sendChoice('paper')" class="bg-green-600 p-3 rounded">ğŸ“„</button>
    <button onclick="sendChoice('scissors')" class="bg-red-600 p-3 rounded">âœ‚ï¸</button>
  </div>

  <!-- RESULT -->
  <div id="result" class="hidden text-center text-lg font-semibold"></div>

  <!-- RESTART -->
  <button id="restart"
    onclick="resetGame()"
    class="hidden mt-4 w-full bg-purple-600 p-2 rounded">
    ğŸ” ÒšĞ°Ğ¹Ñ‚Ğ° Ğ¾Ğ¹Ğ½Ğ°Ñƒ
  </button>

</div>

<script>
/* ================= CONFIG ================= */
const SERVER = "https://sulifaonlinerender.onrender.com";

/* ================= TELEGRAM ================= */
const tg = window.Telegram.WebApp;
tg.expand();
const tgId = tg.initDataUnsafe?.user?.id?.toString();
if (!tgId) alert("Telegram ID Ñ‚Ğ°Ğ±Ñ‹Ğ»Ğ¼Ğ°Ğ´Ñ‹");

/* ================= STATE ================= */
let socket;
let myBalance = 0;
let selectedBet = null;

/* ================= UI ================= */
document.getElementById("tgId").innerText = tgId;

/* ================= REGISTER ================= */
fetch(`${SERVER}/player`, {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify({ tgId })
})
.then(r => r.json())
.then(p => {
  myBalance = p.balance;
  updateBalance();
  connectSocket();
});

/* ================= SOCKET ================= */
function connectSocket() {
  socket = io(SERVER);

  socket.on("waiting", () => {
    setStatus("â³ ÒšĞ°Ñ€ÑÑ‹Ğ»Ğ°Ñ ĞºÒ¯Ñ‚Ñ–Ğ»ÑƒĞ´Ğµ...");
  });

  socket.on("game_start", () => {
    document.getElementById("betPanel").classList.add("hidden");
    setStatus("ğŸ® Ğ¢Ğ°Ò£Ğ´Ğ°!");
    showGame();
  });

  socket.on("game_result", data => {
    hideGame();
    let text = `
      Ğ¡Ñ‚Ğ°Ğ²ĞºĞ°: ${data.bet} ğŸ’°<br>
      Ğ¡ĞµĞ½: ${icon(data.p1)} | ÒšĞ°Ñ€ÑÑ‹Ğ»Ğ°Ñ: ${icon(data.p2)}<br>
    `;

    if (data.winner === "draw") {
      text += "ğŸ¤ Ğ¢ĞµÒ£!";
    } else if (data.winner === tgId) {
      text += "ğŸ† Ğ¡ĞµĞ½ Ğ¶ĞµÒ£Ğ´Ñ–Ò£!";
      myBalance += data.bet;
    } else {
      text += "âŒ Ğ¡ĞµĞ½ Ğ¶ĞµÒ£Ñ–Ğ»Ğ´Ñ–Ò£";
      myBalance -= data.bet;
    }

    updateBalance();
    showResult(text);
  });

  socket.on("error_msg", msg => {
    alert(msg);
    resetGame();
  });
}

/* ================= GAME ================= */
function selectBet(bet) {
  if (bet > myBalance) return alert("Ğ‘Ğ°Ğ»Ğ°Ğ½Ñ Ğ¶ĞµÑ‚ĞºÑ–Ğ»Ñ–ĞºÑÑ–Ğ·");

  selectedBet = bet;
  document.querySelectorAll(".bet-btn").forEach(b => b.classList.remove("bg-green-600"));
  event.target.classList.add("bg-green-600");

  setStatus("ĞĞ¹Ñ‹Ğ½Ò“Ğ° Ò›Ğ¾ÑÑ‹Ğ»Ñƒ...");
  socket.emit("join_game", { tgId, bet });
}

function sendChoice(choice) {
  hideGame();
  setStatus("â³ ÒšĞ°Ñ€ÑÑ‹Ğ»Ğ°Ñ Ñ‚Ğ°Ò£Ğ´Ğ°ÑƒĞ´Ğ°...");
  socket.emit("choice", choice);
}

/* ================= HELPERS ================= */
function resetGame() {
  selectedBet = null;
  document.getElementById("betPanel").classList.remove("hidden");
  document.getElementById("result").classList.add("hidden");
  document.getElementById("restart").classList.add("hidden");
  setStatus("Ğ¡Ñ‚Ğ°Ğ²ĞºĞ° Ñ‚Ğ°Ò£Ğ´Ğ°");
}

function updateBalance() {
  document.getElementById("balance").innerText = myBalance;
}

function setStatus(t) {
  document.getElementById("status").innerText = t;
}

function showGame() {
  document.getElementById("gamePanel").classList.remove("hidden");
}

function hideGame() {
  document.getElementById("gamePanel").classList.add("hidden");
}

function showResult(text) {
  const r = document.getElementById("result");
  r.innerHTML = text;
  r.classList.remove("hidden");
  document.getElementById("restart").classList.remove("hidden");
}

function icon(v) {
  return v === "rock" ? "ğŸª¨" : v === "paper" ? "ğŸ“„" : "âœ‚ï¸";
}
</script>

</body>
</html>
