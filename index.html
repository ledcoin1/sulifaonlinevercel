<!DOCTYPE html>
<html lang="kk">
<head>
  <meta charset="UTF-8">
  <title>Sulifa 1v1</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Telegram Mini App SDK -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gradient-to-br from-indigo-600 to-purple-700 min-h-screen text-white flex items-center justify-center">

<div class="bg-white text-gray-800 rounded-2xl shadow-xl p-6 w-full max-w-md">

  <h1 class="text-2xl font-bold mb-4 text-center">üéÆ Sulifa 1v1</h1>

  <!-- PLAYER INFO -->
  <div class="mb-4 text-sm">
    <div>üÜî ID: <span id="tgId">...</span></div>
    <div>üí∞ –ë–∞–ª–∞–Ω—Å: <span id="balance">0</span></div>
  </div>

  <!-- STATUS -->
  <div id="status" class="text-center font-semibold mb-4">
    –î–∞–π—ã–Ω
  </div>

  <!-- ACTIONS -->
  <div id="actions" class="space-y-3">

    <button onclick="joinGame()"
      class="w-full bg-green-600 text-white py-2 rounded-xl hover:bg-green-700">
      ‚ñ∂Ô∏è –û–π–Ω–∞—É
    </button>

  </div>

  <!-- CHOICES -->
  <div id="choices" class="hidden grid grid-cols-3 gap-2 mt-4">
    <button onclick="sendChoice('rock')" class="choice-btn">ü™® –¢–∞—Å</button>
    <button onclick="sendChoice('paper')" class="choice-btn">üìÑ “ö–∞“ì–∞–∑</button>
    <button onclick="sendChoice('scissors')" class="choice-btn">‚úÇÔ∏è “ö–∞–π—à—ã</button>
  </div>

</div>

<script>
const SERVER = "https://sulifaonlinerender.onrender.com";
const tg = window.Telegram.WebApp;
tg.ready();

// ===== CHECK TELEGRAM =====
if (!tg.initDataUnsafe || !tg.initDataUnsafe.user) {
  document.body.innerHTML = "<h1 class='text-white text-center mt-20'>‚ùå Telegram Mini App –µ–º–µ—Å</h1>";
  throw new Error("Not Telegram Mini App");
}

const tgId = String(tg.initDataUnsafe.user.id);
document.getElementById("tgId").innerText = tgId;

let matchId = null;
let myChoice = null;

// ===== REGISTER PLAYER =====
async function loadPlayer() {
  const res = await fetch(`${SERVER}/player`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ tgId })
  });
  const data = await res.json();
  document.getElementById("balance").innerText = data.balance;
}
loadPlayer();

// ===== JOIN GAME =====
async function joinGame() {
  document.getElementById("status").innerText = "‚è≥ –û–π—ã–Ω —ñ–∑–¥–µ–ª—É–¥–µ...";
  const res = await fetch(`${SERVER}/game/join`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ tgId })
  });

  const data = await res.json();
  matchId = data.matchId;

  if (data.status === "waiting") {
    document.getElementById("status").innerText = "‚åõ “ö–∞—Ä—Å—ã–ª–∞—Å –∫“Ø—Ç—ñ–ª—É–¥–µ...";
    pollMatch();
  } else {
    startGame();
  }
}

// ===== START GAME =====
function startGame() {
  document.getElementById("status").innerText = "‚úä –¢–∞“£–¥–∞—É—ã“£—ã–∑–¥—ã –∂–∞—Å–∞“£—ã–∑";
  document.getElementById("choices").classList.remove("hidden");
}

// ===== SEND CHOICE =====
async function sendChoice(choice) {
  if (myChoice) return;
  myChoice = choice;

  document.getElementById("status").innerText = "‚è≥ “ö–∞—Ä—Å—ã–ª–∞—Å –∫“Ø—Ç—ñ–ª—É–¥–µ...";
  document.getElementById("choices").classList.add("hidden");

  await fetch(`${SERVER}/game/choice`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ matchId, tgId, choice })
  });

  pollMatch();
}

// ===== POLL MATCH STATUS =====
async function pollMatch() {
  const interval = setInterval(async () => {
    const res = await fetch(`${SERVER}/game/choice`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ matchId, tgId })
    });

    const match = await res.json();

    if (match.status === "playing" && !myChoice) {
      startGame();
    }

    if (match.status === "finished") {
      clearInterval(interval);
      showResult(match);
    }
  }, 2000);
}

// ===== SHOW RESULT =====
function showResult(match) {
  let text = "ü§ù –¢–µ“£";

  if (match.winner === tgId) text = "üèÜ –°—ñ–∑ –∂–µ“£–¥—ñ“£—ñ–∑!";
  else if (match.winner !== "draw") text = "‚ùå –°—ñ–∑ –∂–µ“£—ñ–ª–¥—ñ“£—ñ–∑";

  document.getElementById("status").innerText = text;

  myChoice = null;
  matchId = null;
}
</script>

<style>
.choice-btn {
  background: #6366f1;
  color: white;
  padding: 12px;
  border-radius: 12px;
  font-weight: bold;
}
.choice-btn:hover {
  background: #4f46e5;
}
</style>

</body>
</html>
