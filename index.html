<!DOCTYPE html>
<html lang="kk">
<head>
  <meta charset="UTF-8">
  <title>üéÆ Sulifa Player</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
</head>
<body class="bg-gray-100 text-gray-800">

<div class="container mx-auto p-6">
  <h1 class="text-3xl font-bold mb-6">üéÆ Sulifa Player</h1>

  <div class="bg-white p-4 rounded shadow mb-4">
    <p>TG ID: <span id="tgId"></span></p>
    <p>–ë–∞–ª–∞–Ω—Å: <span id="balance">0</span></p>
  </div>

  <div class="bg-white p-4 rounded shadow mb-4">
    <p class="mb-2">–û–π—ã–Ω —Ç–∞“£–¥–∞“£—ã–∑:</p>
    <div class="flex gap-4">
      <button onclick="makeMove('rock')" class="bg-gray-300 px-4 py-2 rounded hover:bg-gray-400">ü™® –¢–∞—Å</button>
      <button onclick="makeMove('paper')" class="bg-gray-300 px-4 py-2 rounded hover:bg-gray-400">üìÑ “ö–∞“ì–∞–∑</button>
      <button onclick="makeMove('scissors')" class="bg-gray-300 px-4 py-2 rounded hover:bg-gray-400">‚úÇÔ∏è “ö–∞–π—à—ã</button>
    </div>
  </div>

  <div class="bg-white p-4 rounded shadow">
    <p id="status">–ö–µ—Ä–µ–∫—Ç—ñ “õ–∞—Ä—Å—ã –æ–π—ã–Ω—à—ã–Ω—ã –∫“Ø—Ç—ñ“£—ñ–∑...</p>
  </div>
</div>

<script>
const SERVER = "https://sulifaonlinerender.onrender.com";

// Telegram Mini App –∞—Ä“õ—ã–ª—ã tgId –∞–ª—É
const tgData = window.Telegram?.WebApp?.initDataUnsafe || {};
const playerId = tgData.user?.id || "test_358418"; // Telegram –±–æ–ª–º–∞—Å–∞ —Ç–µ—Å—Ç ID
document.getElementById("tgId").innerText = playerId;

const socket = io(SERVER);

// –ë–∞–ª–∞–Ω—Å –∂–∞“£–∞—Ä—Ç—É
function updateBalance(balance) {
  document.getElementById("balance").innerText = balance;
}

// –°–µ—Ä–≤–µ—Ä–≥–µ —Ç—ñ—Ä–∫–µ–ª—É
fetch(`${SERVER}/player`, {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify({ tgId: playerId })
})
.then(r => r.json())
.then(data => updateBalance(data.balance));

// –û–π—ã–Ω“ì–∞ “õ–æ—Å—ã–ª—É
socket.emit("joinGame", { tgId: playerId });

let currentRoom = null;

socket.on("waiting", data => {
  document.getElementById("status").innerText = data.message;
});

socket.on("gameStart", data => {
  currentRoom = data.roomId;
  document.getElementById("status").innerText = "–û–π—ã–Ω –±–∞—Å—Ç–∞–ª–¥—ã! –¢–∞“£–¥–∞—É—ã“£—ã–∑–¥—ã –∂–∞—Å–∞“£—ã–∑.";
});

function makeMove(move) {
  if (!currentRoom) return alert("–û–π—ã–Ω –±–∞—Å—Ç–∞–ª–º–∞“ì–∞–Ω");
  socket.emit("playerMove", { roomId: currentRoom, move });
}

socket.on("roundResult", data => {
  const { move1, move2, winner, balances } = data;
  let statusText = `–°—ñ–∑–¥—ñ“£ —Ç–∞“£–¥–∞—É—ã“£—ã–∑: ${move1}, “õ–∞—Ä—Å—ã: ${move2}\n`;

  if (winner === "draw") statusText += "–¢–µ“£ –Ω”ô—Ç–∏–∂–µ!";
  else if ((winner === "player1" && playerId === data.roomBalances?.player1) || 
           (winner === "player2" && playerId === data.roomBalances?.player2)) statusText += "–°—ñ–∑ –∂–µ“£–¥—ñ“£—ñ–∑!";
  else statusText += "–°—ñ–∑ –∂–µ“£—ñ–ª–¥—ñ“£—ñ–∑!";

  document.getElementById("status").innerText = statusText;

  // –ë–∞–ª–∞–Ω—Å live –∂–∞“£–∞—Ä—Ç—É
  if (balances[playerId] !== undefined) updateBalance(balances[playerId]);
});
</script>

</body>
</html>
