<!DOCTYPE html>
<html lang="kk">
<head>
  <meta charset="UTF-8">
  <title>Sulifa 1v1 | MiniApp</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
</head>

<body class="bg-gradient-to-b from-gray-900 via-gray-800 to-gray-900 min-h-screen">

<div class="max-w-2xl mx-auto py-6">

  <!-- TOP PANEL -->
  <div class="flex justify-between items-center bg-gray-800 p-4 rounded-xl shadow-lg mb-6">
    <div>
      <div class="text-gray-400 text-xs">ID</div>
      <div id="tgId" class="text-white font-mono"></div>
    </div>
    <div class="flex flex-col items-end">
      <input id="playerName" type="text" placeholder="–ê—Ç—ã“£—ã–∑"
        class="bg-gray-700 px-3 py-1 rounded text-white text-sm mb-1 w-32 text-right">
      <div class="text-lg font-semibold text-yellow-400">
        –ë–∞–ª–∞–Ω—Å: <span id="balance">0</span> üí∞
      </div>
    </div>
  </div>

  <!-- STATUS & TIMER -->
  <div class="flex justify-between items-center mb-4">
    <div id="status" class="text-yellow-400 font-semibold">–°—Ç–∞–≤–∫–∞ —Ç–∞“£–¥–∞</div>
    <div id="timerBox" class="hidden text-white font-bold text-lg">‚è±Ô∏è <span id="timer">15</span> —Å–µ–∫</div>
  </div>

  <!-- BET ROOMS -->
  <div id="betPanel" class="grid grid-cols-2 gap-4 mb-6">
    <button onclick="joinRoom(500)" class="bet-btn p-4 rounded-xl shadow-md bg-gradient-to-r from-blue-600 to-blue-400 text-white font-bold text-lg">500</button>
    <button onclick="joinRoom(1000)" class="bet-btn p-4 rounded-xl shadow-md bg-gradient-to-r from-green-600 to-green-400 text-white font-bold text-lg">1000</button>
    <button onclick="joinRoom(1500)" class="bet-btn p-4 rounded-xl shadow-md bg-gradient-to-r from-purple-600 to-purple-400 text-white font-bold text-lg">1500</button>
    <button onclick="joinRoom(2000)" class="bet-btn p-4 rounded-xl shadow-md bg-gradient-to-r from-red-600 to-red-400 text-white font-bold text-lg">2000</button>
  </div>

  <!-- GAME PANEL -->
  <div id="gamePanel" class="hidden grid grid-cols-3 gap-4 mb-6">
    <button onclick="sendChoice('rock')" class="choice p-6 bg-gray-700 rounded-2xl shadow-lg text-3xl hover:scale-105 transition-transform">ü™®</button>
    <button onclick="sendChoice('paper')" class="choice p-6 bg-gray-700 rounded-2xl shadow-lg text-3xl hover:scale-105 transition-transform">üìÑ</button>
    <button onclick="sendChoice('scissors')" class="choice p-6 bg-gray-700 rounded-2xl shadow-lg text-3xl hover:scale-105 transition-transform">‚úÇÔ∏è</button>
  </div>

  <!-- RESULT -->
  <div id="result" class="hidden bg-gray-800 p-4 rounded-xl shadow-md text-center text-lg font-bold text-white mb-4"></div>

  <!-- RESTART -->
  <button id="restart" onclick="resetGame()" class="hidden w-full p-3 rounded-xl bg-yellow-500 font-semibold text-black hover:bg-yellow-400 transition-colors">
    üîÅ “ö–∞–π—Ç–∞ –æ–π–Ω–∞—É
  </button>

</div>

<script>
const SERVER = "https://sulifaonlinerender.onrender.com";
const tg = window.Telegram.WebApp;
tg.expand();

const tgId = tg.initDataUnsafe?.user?.id?.toString() || "test_" + Math.random();
document.getElementById("tgId").innerText = tgId;

let socket;
let myBalance = 0;
let currentRoom = null;
let timerInterval;

let isJoining = false;
let inGame = false;

// Load player
fetch(`${SERVER}/player`, {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify({ tgId })
}).then(r => r.json()).then(p => {
  myBalance = p.balance;
  updateBalance();
  connectSocket();
});

// Socket
function connectSocket() {
  socket = io(SERVER);

  socket.on("waiting", () => setStatus("‚è≥ “ö–∞—Ä—Å—ã–ª–∞—Å –∫“Ø—Ç—ñ–ª—É–¥–µ..."));

  socket.on("game_start", ({ roomId, p1Name, p2Name }) => {
    inGame = true;
    isJoining = false;
    currentRoom = roomId;

    const myName = document.getElementById("playerName").value || tgId;
    document.getElementById("playerName").value = myName;

    document.getElementById("betPanel").classList.add("hidden");
    disableBetButtons(true);

    setStatus(`üéÆ “ö–∞—Ä—Å—ã–ª–∞—Å: ${p1Name === myName ? p2Name : p1Name} —Ç–∞“£–¥–∞!`);
    showGame();
    startTimer();
  });

  socket.on("game_result", data => {
    stopTimer();
    hideGame();

    inGame = false;
    isJoining = false;
    disableBetButtons(false);

    let text = data.winner === "draw" ? "ü§ù –¢–µ“£!" :
               data.winner === tgId ? "üèÜ –°–µ–Ω –∂–µ“£–¥—ñ“£!" : "‚ùå –°–µ–Ω –∂–µ“£—ñ–ª–¥—ñ“£";

    showResult(text);
    reloadBalance();
  });

  socket.on("error_msg", msg => { alert(msg); resetGame(); });
}

// Join
function joinRoom(bet) {
  if (isJoining || inGame) return;
  if (myBalance < bet) { alert("–ë–∞–ª–∞–Ω—Å –∂–µ—Ç–∫—ñ–ª—ñ–∫—Å—ñ–∑"); return; }

  const myName = document.getElementById("playerName").value || tgId;
  isJoining = true;
  disableBetButtons(true);
  setStatus("‚è≥ “ö–∞—Ä—Å—ã–ª–∞—Å –∫“Ø—Ç—ñ–ª—É–¥–µ...");
  socket.emit("join_room", { tgId, bet, playerName: myName });
}

// Game
function sendChoice(choice) {
  if (!inGame) return;
  hideGame();
  setStatus("‚è≥ “ö–∞—Ä—Å—ã–ª–∞—Å —Ç–∞“£–¥–∞—É–¥–∞...");
  socket.emit("choice", { roomId: currentRoom, choice });
}

// Timer
function startTimer() {
  let t = 15;
  document.getElementById("timer").innerText = t;
  document.getElementById("timerBox").classList.remove("hidden");

  timerInterval = setInterval(() => {
    t--;
    document.getElementById("timer").innerText = t;
    if (t <= 0) stopTimer();
  }, 1000);
}

function stopTimer() {
  clearInterval(timerInterval);
  document.getElementById("timerBox").classList.add("hidden");
}

// UI
function resetGame() {
  currentRoom = null;
  inGame = false;
  isJoining = false;
  disableBetButtons(false);
  hideGame();
  document.getElementById("result").classList.add("hidden");
  document.getElementById("restart").classList.add("hidden");
  document.getElementById("betPanel").classList.remove("hidden");
  setStatus("–°—Ç–∞–≤–∫–∞ —Ç–∞“£–¥–∞");
}

function disableBetButtons(state) {
  document.querySelectorAll(".bet-btn").forEach(btn => {
    btn.disabled = state;
    btn.classList.toggle("opacity-50", state);
    btn.classList.toggle("cursor-not-allowed", state);
  });
}

function updateBalance() { document.getElementById("balance").innerText = myBalance; }

function reloadBalance() {
  fetch(`${SERVER}/player`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ tgId })
  }).then(r => r.json()).then(p => { myBalance = p.balance; updateBalance(); });
}

function setStatus(text) { document.getElementById("status").innerText = text; }
function showGame() { document.getElementById("gamePanel").classList.remove("hidden"); }
function hideGame() { document.getElementById("gamePanel").classList.add("hidden"); }
function showResult(text) { 
  const r = document.getElementById("result"); 
  r.innerText = text; 
  r.classList.remove("hidden"); 
  document.getElementById("restart").classList.remove("hidden"); 
}
</script>

<style>
.bet-btn {
  transition:0.2s; font-bold text-white;
}
.bet-btn:hover { transform: scale(1.05); }
.choice {
  transition:0.2s;
}
.choice:hover { transform: scale(1.1); }
</style>

</body>
</html>
